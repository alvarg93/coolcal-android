machine:
  environment:
    ANDROID_HOME: /usr/local/android-sdk-linux
    TERM: dumb

#checkout:
#  pre:
#    - curl -L https://raw.githubusercontent.com/netguru/review/master/check.rb | ruby

dependencies:
  cache_directories:
    - /usr/local/android-sdk-linux
    - ~/.android
    - ~/.gradle
  pre:
    - android list sdk --all:
        background: true
  override:
    - "( sleep 5 && while [ 1 ]; do sleep 1; echo y; done ) | android --silent update sdk --no-ui --all --filter 1,2,3,20,59,112,113,123"
    - ./gradlew -q dependencies
  post:
    - android list targets

test:
  pre:
    - echo no | android create avd --force -n test -t android-22
    - emulator -avd test -no-skin -no-window -no-audio -verbose:
        background: true
        parallel: true
    - circle-android wait-for-boot
    - adb logcat:
        background: true
    - ./gradlew assembleStagingDebug assembleStagingDebugAndroidTest --parallel
  override:
    - ./gradlew testStagingDebug --parallel
    - ./wait.sh:    
        parallel: true
    - circle-android wait-for-boot
    - adb install app/build/outputs/apk/app-staging-debug.apk
    - adb install -r app/build/outputs/apk/app-staging-debug-androidTest-unaligned.apk
    - adb shell pm list instrumentation
    - ./run-tests.sh
  post:
    - ./gradlew lintStagingDebug --parallel:
        background: true

deployment:
  master:
    branch: master
    commands:
      - ./gradlew clean uploadStagingDebugToHockeyApp --parallel
  production:
    branch: production
    commands:
      - ./gradlew clean uploadProductionDebugToHockeyApp --parallel
